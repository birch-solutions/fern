import { Audiences } from "@fern-api/configuration";
import { createMockTaskContext } from "@fern-api/task-context";
import { AbstractAPIWorkspace } from "@fern-api/workspace-loader";
import { generateIntermediateRepresentation } from "@fern-api/ir-generator";
import { convertIrToDynamicSnippetsIr } from "../convertIrToDynamicSnippetsIr";
import { dynamic as DynamicSnippets, IntermediateRepresentation } from "@fern-api/ir-sdk";
import { ApiAuth, HttpEndpoint } from "@fern-api/ir-sdk";
import { assertNever } from "@fern-api/core-utils";
import { FernGeneratorExec } from "@fern-fern/generator-exec-sdk";
import urlJoin from "url-join";
import { DynamicSnippetsTestSuite } from "./DynamicSnippetsTestSuite";
import { generatorsYml } from "@fern-api/configuration";

export async function generateDynamicSnippetsTestSuite({
    workspace,
    config,
    audiences,
    language
}: {
    workspace: AbstractAPIWorkspace<unknown>;
    config: FernGeneratorExec.GeneratorConfig;
    audiences: Audiences;
    language: generatorsYml.GenerationLanguage;
}): Promise<DynamicSnippetsTestSuite> {
    const taskContext = createMockTaskContext();
    const fernWorkspace = await workspace.toFernWorkspace({
        context: taskContext
    });
    const intermediateRepresentation = await generateIntermediateRepresentation({
        workspace: fernWorkspace,
        generationLanguage: language,
        audiences,
        keywords: undefined,
        smartCasing: true,
        includeOptionalRequestPropertyExamples: true,
        disableExamples: false,
        readme: undefined,
        version: undefined,
        packageName: undefined,
        context: taskContext
    });
    const dynamicIntermediateRepresentation = await convertIrToDynamicSnippetsIr(intermediateRepresentation);
    return {
        ir: dynamicIntermediateRepresentation,
        config,
        requests: getEndpointSnippetRequests({ ir: intermediateRepresentation })
    };
}

function getEndpointSnippetRequests({
    ir
}: {
    ir: IntermediateRepresentation;
}): DynamicSnippets.EndpointSnippetRequest[] {
    const requests: DynamicSnippets.EndpointSnippetRequest[] = [];
    for (const endpoint of getAllEndpoints(ir)) {
        const location: DynamicSnippets.EndpointLocation = {
            path: getFullPathForEndpoint(endpoint),
            method: endpoint.method
        };
        const auth = getAuthValues(ir.auth);
        for (const example of [...endpoint.userSpecifiedExamples, ...endpoint.autogeneratedExamples]) {
            requests.push({
                endpoint: location,
                auth,
                headers: Object.fromEntries(
                    [...(example.example?.serviceHeaders ?? []), ...(example.example?.endpointHeaders ?? [])].map(
                        (header) => {
                            return [header.name.wireValue, header.value.jsonExample];
                        }
                    )
                ),
                pathParameters: Object.fromEntries(
                    [
                        ...(example.example?.rootPathParameters ?? []),
                        ...(example.example?.servicePathParameters ?? []),
                        ...(example.example?.endpointPathParameters ?? [])
                    ].map((parameter) => {
                        return [parameter.name.originalName, parameter.value.jsonExample];
                    })
                ),
                queryParameters: Object.fromEntries(
                    [...(example.example?.queryParameters ?? [])].map((parameter) => {
                        return [parameter.name.wireValue, parameter.value.jsonExample];
                    })
                ),
                requestBody: example.example?.request?.jsonExample
            });
        }
    }
    return requests;
}

function getAuthValues(auth: ApiAuth): DynamicSnippets.AuthValues | undefined {
    const scheme = auth.schemes[0];
    if (scheme == null) {
        return undefined;
    }
    switch (scheme.type) {
        case "bearer":
            return DynamicSnippets.AuthValues.bearer({
                token: "<token>"
            });
        case "basic":
            return DynamicSnippets.AuthValues.basic({
                username: "<username>",
                password: "<password>"
            });
        case "header":
            return DynamicSnippets.AuthValues.header({
                value: "<value>"
            });
        case "oauth":
            // TODO: Implement OAuth.
            return undefined;
        default:
            assertNever(scheme);
    }
}

function getAllEndpoints(ir: IntermediateRepresentation): HttpEndpoint[] {
    return Object.values(ir.services).flatMap((service) => Object.values(service.endpoints));
}

function getFullPathForEndpoint(endpoint: HttpEndpoint): string {
    let url = "";
    if (endpoint.fullPath.head.length > 0) {
        url = urlJoin(url, endpoint.fullPath.head);
    }
    for (const part of endpoint.fullPath.parts) {
        url = urlJoin(url, "{" + part.pathParameter + "}");
        if (part.tail.length > 0) {
            url = urlJoin(url, part.tail);
        }
    }
    return url.startsWith("/") ? url : `/${url}`;
}
